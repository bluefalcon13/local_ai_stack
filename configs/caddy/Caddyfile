{
    email {$CLOUDFLARE_EMAIL}
    https_port 8443
    # auto_https off  # Optional: keep this if you only want it to touch 8443
}

{$DOMAIN_NAME}:8443 {

    # 1. Identity & mTLS
    tls /etc/caddy/certs/{$TLS_CLIENT_CERT_NAME} /etc/caddy/certs/{$TLS_CLIENT_KEY_NAME} {
        client_auth {
            mode verify_if_given
            trust_pool file /etc/caddy/certs/{$CLOUDFLARE_AUTH_ORIGIN_PULL_CERT_NAME}
        }
    }

    # 2. LAN & Cloudflare Guard (Section 1b)
    @not_local_or_cloudflare {
        not remote_ip 192.168.1.0/24
        not remote_ip 172.16.0.0/12
    }
    respond @not_local_or_cloudflare 403 "Access Denied"

    # 3. Security Hardening
    header {
        X-Content-Type-Options nosniff
        X-Frame-Options DENY
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    }

    # 4. Service Routing (The "Traffic Controller")

    # Phoenix: Strips /phoenix/ from the path
    handle_path /phoenix/* {
        reverse_proxy phoenix:6006
    }

    # LangGraph: Strips /v1/ from the path
    handle_path /v1/* {
        reverse_proxy langgraph:8000
    }

    # Open WebUI (The "Brain"): Captures everything else
    handle /* {
        # CRITICAL: These headers allow Google OAuth to "see" the HTTPS connection        
        reverse_proxy open-webui:8080 {
            header_up X-Forwarded-Proto https
            header_up X-Forwarded-Host {host}
            header_up Host {host}
            header_up X-Real-IP {remote_host}
        }
    }
}